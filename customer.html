<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Allergen Information</title>
  <link rel="stylesheet" href="style.css"/>
</head>
<body>
  <header class="topbar">
    <div class="brand">
      <div class="logo">üçΩÔ∏è</div>
      <div>
        <div class="title" id="biz">Allergen Information</div>
        <div class="subtitle">Customer view (simple)</div>
      </div>
    </div>
    <div class="top-actions">
      <a class="btn" id="backHome" href="./">Home</a>
    </div>
  </header>

  <main class="container">
    <section class="card" id="content">
      <p class="h2">Loading‚Ä¶</p>
      <p class="p">Please wait.</p>
    </section>

    <section class="card" style="margin-top:14px">
      <p class="h2">Important</p>
      <p class="p">
        This information is provided by the business. If you have severe allergies, always contact the takeaway directly.
      </p>
    </section>
  </main>

  <script>
    const ALLERGENS = [
      { key: "celery", label: "Celery" },
      { key: "gluten", label: "Cereals containing gluten" },
      { key: "crustaceans", label: "Crustaceans" },
      { key: "eggs", label: "Eggs" },
      { key: "fish", label: "Fish" },
      { key: "lupin", label: "Lupin" },
      { key: "milk", label: "Milk" },
      { key: "molluscs", label: "Molluscs" },
      { key: "mustard", label: "Mustard" },
      { key: "nuts", label: "Nuts" },
      { key: "peanuts", label: "Peanuts" },
      { key: "sesame", label: "Sesame" },
      { key: "soya", label: "Soya" },
      { key: "sulphites", label: "Sulphur dioxide / sulphites" },
    ];

    const $ = (s)=>document.querySelector(s);

    function escapeHtml(s){
      return String(s ?? "").replace(/[&<>"']/g, c => ({
        "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
      }[c]));
    }

    async function loadPublicData() {
      // If owner uploaded public-data.json to GitHub repo root,
      // we can read it and show by slug.
      const res = await fetch("./public-data.json", { cache: "no-store" });
      if (!res.ok) throw new Error("no public-data");
      return await res.json();
    }

    function renderTakeaway(tw){
      $("#biz").textContent = tw.name || "Allergen Information";
      const rows = (tw.items || []).map(it=>{
        const activeKeys = it.allergens || [];
        const chips = activeKeys.length
          ? activeKeys.map(k=>{
              const label = (ALLERGENS.find(a=>a.key===k)?.label) || k;
              return `<span class="chip red">${escapeHtml(label)}</span>`;
            }).join("")
          : `<span class="chip green">No declared allergens</span>`;

        return `
          <tr>
            <td>
              <div style="font-weight:900">${escapeHtml(it.name || "")}</div>
              <div class="muted">${escapeHtml(it.category || "")}</div>
            </td>
            <td class="muted">${escapeHtml(it.ingredients || "")}</td>
            <td><div class="chips">${chips}</div></td>
          </tr>
        `;
      }).join("");

      $("#content").innerHTML = `
        <p class="h2">Allergen Information</p>
        <p class="p">Updated: ${escapeHtml(tw.updatedAt || "")}</p>
        <hr class="sep"/>
        ${(tw.items && tw.items.length) ? `
          <table class="table">
            <tr>
              <th style="width:26%">Item</th>
              <th>Ingredients</th>
              <th style="width:30%">Allergens</th>
            </tr>
            ${rows}
          </table>
        ` : `
          <div class="notice">
            No items published yet. Please check again later.
          </div>
        `}
      `;
    }

    async function main(){
      const u = new URL(location.href);
      const slug = u.searchParams.get("t");

      if (!slug) {
        $("#content").innerHTML = `
          <p class="h2">Invalid link</p>
          <p class="p">Missing takeaway id (t).</p>
        `;
        return;
      }

      try{
        const data = await loadPublicData();
        const tw = (data.takeaways || []).find(x => x.slug === slug);
        if (!tw) throw new Error("not found");
        renderTakeaway(tw);
      }catch(err){
        $("#content").innerHTML = `
          <p class="h2">Not published yet</p>
          <p class="p">
            This takeaway has not been published. The business owner must upload <span class="kbd">public-data.json</span> to the website.
          </p>
          <div class="notice" style="margin-top:10px">
            If you are the owner: Open the Builder ‚Üí Export ‚Üí ‚ÄúDownload public-data.json‚Äù ‚Üí upload it to GitHub repo root.
          </div>
        `;
      }
    }

    main();
  </script>
</body>
</html>
