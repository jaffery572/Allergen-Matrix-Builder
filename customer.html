<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Allergen Information</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body class="customer-body">
  <main class="container">
    <section class="card">
      <div class="row space wrap">
        <div>
          <div id="cxBiz" class="h2">Allergen Information</div>
          <div id="cxSub" class="p muted">Menu items & allergens (customer view)</div>
        </div>
        <a class="btn" href="./index.html">Owner Panel</a>
      </div>

      <div class="p small muted" id="cxMeta"></div>

      <div class="row space wrap" style="margin-top:10px">
        <input id="cxSearch" class="input" placeholder="Search item name / category..." />
        <button id="cxPrint" class="btn">Print / Save PDF</button>
      </div>

      <div class="table-wrap" style="margin-top:12px">
        <table class="grid" id="cxTable"></table>
      </div>
    </section>
  </main>

  <script>
    const ALLERGENS = [
      { key:"celery", label:"Celery" },
      { key:"gluten", label:"Cereals containing gluten" },
      { key:"crustaceans", label:"Crustaceans" },
      { key:"eggs", label:"Eggs" },
      { key:"fish", label:"Fish" },
      { key:"lupin", label:"Lupin" },
      { key:"milk", label:"Milk" },
      { key:"molluscs", label:"Molluscs" },
      { key:"mustard", label:"Mustard" },
      { key:"nuts", label:"Nuts" },
      { key:"peanuts", label:"Peanuts" },
      { key:"sesame", label:"Sesame" },
      { key:"soya", label:"Soya" },
      { key:"sulphites", label:"Sulphur dioxide / sulphites" }
    ];

    function getParam(name){
      const u = new URL(location.href);
      return u.searchParams.get(name) || "";
    }

    function loadState(){
      try { return JSON.parse(localStorage.getItem("amb_state_v3") || "null"); }
      catch { return null; }
    }

    function safe(x){ return (x ?? "").toString(); }

    function buildTable(bizName, items){
      document.getElementById("cxBiz").textContent = bizName || "Allergen Information";
      document.getElementById("cxMeta").textContent =
        `Updated: ${new Date().toLocaleString()} • Items: ${items.length}`;

      const t = document.getElementById("cxTable");
      const thead = `
        <thead>
          <tr>
            <th class="sticky">Item</th>
            <th>Category</th>
            ${ALLERGENS.map(a=>`<th class="rot">${a.label}</th>`).join("")}
          </tr>
        </thead>
      `;

      const tbody = `
        <tbody>
          ${items.map(it=>{
            const alls = it.allergens || {};
            return `
              <tr>
                <td class="sticky"><b>${safe(it.name)}</b></td>
                <td>${safe(it.category)}</td>
                ${ALLERGENS.map(a=>`<td class="center">${alls[a.key] ? "✓" : ""}</td>`).join("")}
              </tr>
            `;
          }).join("")}
        </tbody>
      `;

      t.innerHTML = thead + tbody;
    }

    function render(){
      const slug = getParam("t").trim();
      const st = loadState();
      if (!st || !st.takeaways || !slug || !st.takeaways[slug]) {
        buildTable("Allergen Information", []);
        document.getElementById("cxSub").textContent =
          "Link invalid / data not found on this device.";
        return;
      }

      const tw = st.takeaways[slug];
      document.getElementById("cxSub").textContent =
        "Customer view (read-only).";

      const items = Array.isArray(tw.items) ? tw.items : [];
      buildTable(tw.name || slug, items);

      const input = document.getElementById("cxSearch");
      input.addEventListener("input", ()=>{
        const q = input.value.trim().toLowerCase();
        const filtered = items.filter(it=>{
          const a = (it.name||"").toLowerCase();
          const b = (it.category||"").toLowerCase();
          return a.includes(q) || b.includes(q);
        });
        buildTable(tw.name || slug, filtered);
      });

      document.getElementById("cxPrint").addEventListener("click", ()=>window.print());
    }

    render();
  </script>
</body>
</html>
